% This is a comment.
% the region directly below this comment, up till the command \begin{document} is known as the 'preamble'
% basic setup
\documentclass{article}
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}

% for mathematics
\usepackage{amsmath}
\usepackage{amsthm}
% define theorems, lemmas, etc
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}{Lemma}
\newtheorem{corollary}{Corollary}
\newtheorem{definition}{Definition}
\newtheorem{example}{Example}
\usepackage{amssymb}

% for adjusting margins
\usepackage{geometry}
\geometry{
	a4paper,
 	left=26mm,
 	right=20mm,
 	top=33mm,
 	bottom=38mm
}

% for introducing urls
\usepackage{url}

% for colored text
\usepackage{color}

% for creating lists
\usepackage{enumerate}

% for import graphics
\usepackage{graphicx}

% include algorithm package
\usepackage[]{algorithm2e, setspace}

% change font to times new roman
%\usepackage{times}

% add padding to in between paragraphs
\setlength{\parskip}{1em}

% eliminate indent at start of paragraph
\setlength\parindent{0pt}

% title details
\title{QF4102 Financial Modelling and Computation Assignment 3}
%\date{}
\author{G01 Wang Zexin, Chen Penghao}

%~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
\begin{document}

% insert title
\maketitle
% make a new page
\newpage

\section{Transformed Black-Scholes PDE model}
Consider the \textbf{transformed} Black-Scholes PDE model:
\begin{equation*}
  \begin{cases}
    \frac{\partial u}{\partial t} + \frac{\sigma ^ {2}}{2}\frac{\partial ^ {2} u}{\partial x^{2}} + (r - q - \frac{\sigma^{2}}{2})\frac{\partial u}{\partial x} -ru = 0, & x \in (-\infty, \infty), t \in [0, T) \\
    u(x, T) = \varphi(x), & 
  \end{cases}
\end{equation*}

\subsection{Derivation of fully implicit scheme}
Evaluate partial derivatives at $(x_{n}^{i}, t_{n})$ where $t_{n} = n\Delta t, x_{n}^{i} = i\Delta x, n \in [0, \frac{T}{\Delta t}), i \in [-x_{max}, x_{max}], I_{max} = \frac{x_{max}}{\Delta x}$
$$ \text{Use the forward time finite difference formulae : } \left. \frac{\partial u}{\partial t} \right| _{(x_{n}^{i}, t_{n})} = \frac{u_{n+1}^{i} - u_{n}^{i}}{\Delta t} + O(\Delta t)$$
$$ \text{Use the centred space finite difference formulae : } \left. \frac{\partial u}{\partial x} \right| _{(x_{n}^{i}, t_{n})} = \frac{u_{n}^{i+1} - u_{n}^{i-1}}{2\Delta x} + O[(\Delta x)^{2}]$$
$$ \text{Use the centred space finite difference formulae : } \left. \frac{\partial^{2} u}{\partial x^{2}} \right| _{(x_{n}^{i}, t_{n})} = \frac{u_{n}^{i+1} - 2u_{n}^{i} + u_{n}^{i-1}}{(\Delta x)^{2}} + O[(\Delta x)^{2}]$$

The finite difference equation is hence : 
$$ \frac{u_{n+1}^{i} - u_{n}^{i}}{\Delta t} + O(\Delta t) + \frac{\sigma ^ {2}}{2}\frac{u_{n}^{i+1} -2u_{n}^{i} + u_{n}^{i-1}}{(\Delta x)^{2}} + (r - q - \frac{\sigma^{2}}{2})\frac{u_{n}^{i+1} - u_{n}^{i-1}}{2\Delta x} + O[(\Delta x)^{2}] -ru_{n}^{i} = 0$$
$$ \frac{u_{n+1}^{i} - u_{n}^{i}}{\Delta t} + O(\Delta t) + O[(\Delta x)^{2}] = -\frac{\sigma ^ {2}}{2}\frac{u_{n}^{i+1} -2u_{n}^{i} + u_{n}^{i-1}}{(\Delta x)^{2}} - (r - q - \frac{\sigma^{2}}{2})\frac{u_{n}^{i+1} - u_{n}^{i-1}}{2\Delta x} + ru_{n}^{i}$$
$$ \frac{U_{n+1}^{i} - U_{n}^{i}}{\Delta t} = rU_{n}^{i} - \frac{\sigma ^ {2}}{2}\frac{U_{n}^{i+1} -2U_{n}^{i} + U_{n}^{i-1}}{(\Delta x)^{2}} - (r - q - \frac{\sigma^{2}}{2})\frac{U_{n}^{i+1} - U_{n}^{i-1}}{2\Delta x}$$
$$ U_{n+1}^{i} = U_{n}^{i} + \Delta t[rU_{n}^{i} - \frac{\sigma ^ {2}}{2}\frac{U_{n}^{i+1} -2U_{n}^{i} + U_{n}^{i-1}}{(\Delta x)^{2}} - (r - q - \frac{\sigma^{2}}{2})\frac{U_{n}^{i+1} - U_{n}^{i-1}}{2\Delta x}]$$
$$ U_{n+1}^{i} = U_{n}^{i} (1+ r \Delta t) - \frac{\Delta t}{2(\Delta x)^{2}}[\sigma ^ {2}(U_{n}^{i+1} -2U_{n}^{i} + U_{n}^{i-1}) + \Delta x(r - q - \frac{\sigma^{2}}{2})(U_{n}^{i+1} - U_{n}^{i-1})]$$


$$ U_{n+1}^{i} = U_{n}^{i-1}[\frac{\Delta t(r - q - \frac{\sigma^{2}}{2})}{2\Delta x} -\frac{\sigma^{2}\Delta t}{2(\Delta x)^{2}}] + U_{n}^{i} [1+ r \Delta t + \frac{\sigma ^ {2} \Delta t}{(\Delta x)^{2}}] + U_{n}^{i+1}[- \frac{\Delta t(r - q - \frac{\sigma^{2}}{2})}{2\Delta x} -\frac{\sigma^{2}\Delta t}{2(\Delta x)^{2}} ]$$
$$ U_{n+1}^{i} = aU_{n}^{i-1}+ bU_{n}^{i} + cU_{n}^{i+1} , \forall I_{min}+1 \le i \le I_{max}-1$$
\hspace*{100pt} where $a = \gamma-\frac{\alpha}{2}, b = \beta + \alpha, c = -\gamma-\frac{\alpha}{2}, \alpha = \frac{\sigma^{2}\Delta t}{(\Delta x)^{2}}, \beta = 1+ r \Delta t, \gamma = \frac{\Delta t(r - q - \frac{\sigma^{2}}{2})}{2\Delta x}$\\[3mm]
The boundary conditions are as follows:\\
$$U_{n}^{I_{max}} = e^{-q(T-n \Delta t)}\exp(I_{max}\Delta x) - e^{-r(T-n \Delta t)}X \text{, when the underlying value is very large at} \exp(I_{max}\Delta x)$$
$$U_{n}^{I_{min}} = 0\text{, when the underlying value is very small at} \exp(I_{min}\Delta x)$$
\newpage
With the values of $U_{n}^{I_{min}}$ and $U_{n}^{I_{max}}$ specified, we can express the FDE into matrix form.
\[
\begin{bmatrix}
    b & c & \dots & \dots  & \dots & \dots & \dots\\
    a & b & c & \dots  & \dots & \dots & \dots\\
    \dots & a & b & c & \dots & \dots & \dots\\
    \vdots & \vdots & \vdots & \ddots & \vdots & \vdots & \vdots \\
    \dots & \dots & \dots & a & b & c & \dots\\
    \dots & \dots & \dots & \dots & a & b & c\\
    \dots & \dots & \dots & \dots & \dots & a & b\\
\end{bmatrix}
\begin{bmatrix}
    U_{n}^{I_{min}+1}\\
    U_{n}^{I_{min}+2}\\
    U_{n}^{I_{min}+3}\\
    \dots \\
    U_{n}^{I_{max}-3}\\
    U_{n}^{I_{max}-2}\\
    U_{n}^{I_{max}-1}
\end{bmatrix}
=
\begin{bmatrix}
    U_{n+1}^{I_{min}+1}\\
    U_{n+1}^{I_{min}+2}\\
    U_{n+1}^{I_{min}+3}\\
    \dots \\
    U_{n+1}^{I_{max}-3}\\
    U_{n+1}^{I_{max}-2}\\
    U_{n+1}^{I_{max}-1}
\end{bmatrix}
+
\begin{bmatrix}
    -aU_{n}^{I_{min}}\\
    0\\
    \vdots \\
    \vdots \\
    0\\
    -cU_{n}^{I_{max}}
\end{bmatrix}
\]

More concisely, we can name the tridiagonal matrix $A$ and the right hand side vector $F$ to express the FDE in this form: $AU_{n} = U_{n+1} + F \to U_{n} = A^{-1}(U_{n+1} + F)$

\subsection{Finite Difference Scheme Algorithm on fully implicit scheme}

\begin{algorithm}[H]
\setstretch{1.5}
	\KwData{$S_0$, $X$, $r$, $T$, $\sigma$, $I$, $N$, $x_{max}$}
	\KwResult{$c_{\text{IDS}}$, Option Premium}
	$\Delta t = \dfrac{T}{N}$, 
	$\Delta x = \dfrac{x_{max}}{I}$\;
	$\alpha = \frac{\Delta t(r - q - \frac{\sigma^{2}}{2})}{2\Delta x}$\;
	$\beta = 1+ r \Delta t$\;
	$\gamma = \frac{\sigma^{2}\Delta t}{2(\Delta x)^{2}}$\;
	$a = \alpha - \gamma$\;
	$b = \beta + \alpha$\;
	$c = -\alpha - \gamma$\;
	
	\For {$i = -I+1, -I+2, \dots, I-2, I-1 $} {
		$U_{N}^{i} = max(\exp(i\Delta x) - X, 0)$\;
	}
	
	Generate a tridiagonal matrix $A$ of dimension $(2I-1) * (2I-1)$, \\
	with $A_{i,i} = b\, \forall i = 1, 2, \dots 2I-1$,$A_{i,i-1} = b\, \forall i = 2, \dots 2I-1$, $A_{i,i+1} = b\, \forall i = 1, 2, \dots 2I-2$.\\
	
	\For {$j = N-1, N-2, \dots , 0$} {
		Generate a vector $F$ of length $(2I-1)$, with $F_{2I-1} = c\exp(-r(T-j \Delta t))(S_{max} - X)$, $F_{i} = 0$ otherwise\;
		$U_{j} = A^{-1} (U_{j+1} + F)$\;
	}
	$i_0 = round \left (\dfrac{\ln{S_0}}{\Delta x} \right )$\;
	$c_{\text{IDS}} = U_0^{i_0}$\;
	
\end{algorithm}


\section{Valuation of digital call option}

\subsection{Algo}



\end{document}